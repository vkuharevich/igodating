<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet id="2024-11-15_00_00_00" author="Ihar Smolka">
        <sql>
            CREATE TABLE country(
                id bigserial PRIMARY KEY,
                code varchar(2) NOT NULL,
                name varchar(100) NOT NULL,
                created_at timestamp default current_timestamp,
                deleted_at timestamp,

                UNIQUE (code, deleted_at),
                UNIQUE ("name", deleted_at)
            );

            CREATE INDEX country_code_idx ON country(code);
            CREATE INDEX country_name_idx ON country("name");
        </sql>

        <sql>
            CREATE TABLE region(
                id bigserial PRIMARY KEY,
                name varchar(100) NOT NULL,
                country_id bigint NOT NULL REFERENCES country(id) ON DELETE CASCADE,
                created_at timestamp default current_timestamp,
                deleted_at timestamp,

                UNIQUE ("name", deleted_at)
            );

            CREATE INDEX region_name_idx ON region("name");
            CREATE INDEX region_country_idx ON region("country_id");
        </sql>

        <sql>
            CREATE TABLE city(
                id bigserial PRIMARY KEY,
                name varchar(100) NOT NULL,
                region_id bigint NOT NULL REFERENCES region(id) ON DELETE CASCADE,
                created_at timestamp default current_timestamp,
                deleted_at timestamp
            );

            CREATE INDEX city_name_idx ON city("name");
            CREATE INDEX city_region_idx ON city("region_id");
        </sql>

        <sql>
            CREATE TABLE questionary_template(
                id bigserial PRIMARY KEY,
                name varchar(100) NOT NULL,
                description text NOT NULL,
                created_at timestamp default current_timestamp,
                deleted_at timestamp,

                UNIQUE (name, deleted_at)
            );

            CREATE INDEX questionary_template_name_idx ON questionary_template("name");
        </sql>

        <sql>
            CREATE TABLE question_block(
                id bigserial PRIMARY KEY,
                name varchar(500) NOT NULL,
                description varchar(500),
                questionary_template_id bigint NOT NULL REFERENCES questionary_template(id) ON DELETE CASCADE,

                UNIQUE (name, questionary_template_id)
            );

            CREATE INDEX question_block_template_id_idx ON question_block(questionary_template_id);
        </sql>

        <sql>
            CREATE TYPE question_answer_type as enum('FREE_FORM', 'CHOICE', 'MULTIPLE_CHOICE', 'NUMERIC');

            CREATE TABLE question(
                id bigserial PRIMARY KEY,
                questionary_template_id bigint NOT NULL REFERENCES questionary_template(id) ON DELETE CASCADE,
                question_block_id bigint REFERENCES question_block(id),
                title varchar(500) NOT NULL,
                description text NOT NULL,
                answer_type question_answer_type NOT NULL,
                is_mandatory boolean default false,
                from_val numeric,
                to_val numeric,
                created_at timestamp default current_timestamp,
                answer_options varchar[],

                UNIQUE (questionary_template_id, title)
            );

            CREATE INDEX question_template_idx ON question(questionary_template_id);
            CREATE INDEX question_block_idx ON question(question_block_id);
        </sql>

        <sql>
            CREATE TYPE rule_matching_type as enum('EQUALS', 'LIKE', 'IN_RANGE', 'MORE_THEN', 'LESS_THEN', 'IN_SET', 'SEMANTIC_RANGING');

            CREATE TYPE rule_access_type as enum('PUBLIC', 'PRIVATE');

            CREATE TABLE matching_rule(
                id bigserial PRIMARY KEY,
                question_id bigint NOT NULL REFERENCES question(id) ON DELETE CASCADE,
                matching_type rule_matching_type NOT NULL,
                default_values jsonb,
                access_type rule_access_type NOT NULL,
                is_mandatory_for_matching boolean,
                created_at timestamp default current_timestamp,

                UNIQUE (question_id)
            );

            CREATE INDEX matching_rule_question_idx ON matching_rule(question_id);
        </sql>

        <sql>
            CREATE TYPE user_questionary_status as enum('DRAFT', 'ON_PROCESSING', 'PUBLISHED', 'NEEDS_CHANGES', 'DELETED');

            CREATE TABLE user_questionary(
                id bigserial PRIMARY KEY,
                title varchar(500) NOT NULL,
                description text NOT NULL,
                user_id varchar(36) NOT NULL,
                questionary_template_id bigint NOT NULL REFERENCES questionary_template(id),
                questionary_status user_questionary_status NOT NULL,
                embedding vector(512) NOT NULL default array[0.014341060072183609, -0.027605779469013214, -0.03280467912554741, -0.029980195686221123, -0.10372629761695862, 0.019317615777254105, 0.010519384406507015, -0.06565854698419571, -0.009553816169500351, -0.03123318776488304, -0.04740457981824875, -0.002246688585728407, -0.02437324821949005, 0.012124676257371902, 0.0211077481508255, 0.03110397979617119, 0.02298356033861637, -0.014911982230842113, -0.0016138035571202636, -0.017748884856700897, -0.002735106972977519, 0.06060100346803665, 0.046564243733882904, -0.0006450985092669725, 0.010954085737466812, -0.007578673306852579, 0.014802138321101665, 0.013306185603141785, -0.0064726900309324265, -0.04463203251361847, -0.019144270569086075, -0.01532841194421053, -0.007377366069704294, -0.058934636414051056, -0.018203455954790115, -0.06053435057401657, -0.04911768436431885, -0.025024306029081345, -0.0016655399231240153, -0.0747462809085846, 0.03750823065638542, -0.013794535771012306, -0.025388725101947784, -0.05742059275507927, 0.011333196423947811, -0.04120830073952675, -0.019789937883615494, 0.055618152022361755, 0.0655074194073677, -0.005094147752970457, -0.019161203876137733, 0.01020242739468813, -0.05153616890311241, -0.03056015446782112, -0.04521102085709572, 0.00014103949069976807, -0.020860662683844566, 0.008295644074678421, -0.014046226628124714, 0.068634994328022, 0.054066821932792664, 0.0014780842466279864, -0.028883779421448708, 0.02231508679687977, -0.021878162398934364, 0.0556655079126358, -0.052481718361377716, -0.007236827630549669, 0.007599432021379471, -0.0139626394957304, -0.003969332668930292, 0.014387540519237518, -0.02738659456372261, 0.07999090850353241, -0.007982518523931503, 0.030987225472927094, 0.04417157918214798, 0.01335520576685667, -0.012314260005950928, 0.0009773416677489877, 0.05722612142562866, -0.05475175753235817, -0.25683245062828064, 0.035313960164785385, -0.013799258507788181, -0.02992945723235607, -0.005676343105733395, 0.06310182809829712, -0.05133238062262535, -0.014721684157848358, -0.008113323710858822, 0.01920001581311226, -0.1390589028596878, 0.03632718697190285, -0.016151145100593567, 0.2652316689491272, -0.08215721696615219, 0.04076826944947243, -0.02964845672249794, -0.038880106061697006, 0.012842405587434769, 0.009805010631680489, 0.02954845502972603, 0.053980592638254166, 0.0074790967628359795, -0.031160295009613037, 0.008876107633113861, 0.018099093809723854, -0.07139096409082413, -0.011027054861187935, -0.06835465878248215, 0.10131093859672546, -0.03208450227975845, 0.0478689968585968, 0.09448250383138657, -0.036757998168468475, 0.04943295568227768, -0.0043378411792218685, 0.010279277339577675, 0.009379899129271507, -0.041766613721847534, -0.0018432748038321733, 0.02413289248943329, -0.024561922997236252, 0.0254379753023386, -0.006542332004755735, -0.013629444874823093, 0.006770647130906582, -0.031184758991003036, 0.010451766662299633, 0.0491819754242897, 0.07732836902141571, 0.00863733235746622, 0.03483894094824791, 0.06759925186634064, 0.023165883496403694, 0.05076191574335098, -0.00035487671266309917, -0.06777434796094894, -0.06396180391311646, 0.03546470031142235, 0.029537566006183624, 0.00872752070426941, 0.005824611056596041, -0.011912696994841099, 0.012986305169761181, -0.0033954973332583904, -0.00022137409541755915, 0.028860200196504593, 0.011840051040053368, -0.033122651278972626, 0.035237185657024384, 0.011496246792376041, 0.015475396066904068, -0.034677330404520035, 0.005317801143974066, -0.01604299247264862, 0.00987557228654623, 0.039597250521183014, 0.031029265373945236, 0.022292735055088997, -0.03841140493750572, -0.06867966800928116, -0.021646685898303986, -0.008020523004233837, 0.0021735106129199266, 0.02279178611934185, -0.06486734747886658, -0.002415414433926344, 0.018533911556005478, -0.03497866541147232, 0.21370898187160492, -0.02663196623325348, -0.02475612424314022, 0.0029926609713584185, -0.00012053735554218292, 0.023655932396650314, -0.035634223371744156, -0.046230513602495193, -0.023098081350326538, 0.011102722957730293, 0.0030336950439959764, 0.08211474120616913, -0.01785214990377426, -0.03692883998155594, 0.030545208603143692, -0.041680801659822464, -0.08344227820634842, 0.056951284408569336, -0.10730384290218353, 0.020631829276680946, -0.04899197071790695, 0.09331610053777695, -0.0060907225124537945, -0.02680431492626667, -0.025380216538906097, 0.004814577754586935, 0.007664903532713652, -0.04011857882142067, 0.04463568702340126, -0.005032900720834732, -0.14400173723697662, -0.04628715664148331, -0.03550359979271889, 0.060912374407052994, -0.014420829713344574, -0.035987433046102524, -0.07129567861557007, -0.011751738376915455, 0.0028482270427048206, -0.02816328965127468, -0.042190514504909515, 0.007293235044926405, 0.005932391155511141, -0.001392423757351935, -0.006911747623234987, 0.04062550887465477, 0.02762281522154808, 0.029838265851140022, 0.03678964823484421, -0.01555476151406765, -1.843809150159359e-05, 0.0008270423277281225, 0.030461343005299568, 0.008550792932510376, 0.022756420075893402, 5.537550896406174e-05, -0.022827446460723877, 0.053814660757780075, 0.008023635484278202, 0.034993674606084824, 0.08671680092811584, -0.04377816617488861, 0.018135420978069305, 0.013611405156552792, -0.024800501763820648, 0.016457652673125267, -0.008617253974080086, -0.01537779439240694, 0.11262339353561401, -0.0012704941909760237, -0.05413299798965454, 0.013812754303216934, 0.009995478205382824, -0.01712622679769993, 0.00156333576887846, 0.050016697496175766, -0.019929245114326477, 0.03022580035030842, 0.08769746124744415, 0.05331112816929817, 0.044318635016679764, 0.08130493015050888, -0.022384822368621826, 0.021750319749116898, 0.04563837870955467, -0.05084657669067383, -0.06129883602261543, 0.0054079629480838776, 0.019990576431155205, 0.005750614684075117, 0.02499549463391304, 0.03314658999443054, 0.019120385870337486, 0.027811316773295403, 0.04462806507945061, 0.02008739672601223, -0.015443132258951664, 0.0565812885761261, -0.031016994267702103, -0.027012987062335014, 0.05165203660726547, -0.013749041594564915, 0.02178836241364479, 0.05350053682923317, -0.012249337509274483, 0.01313923392444849, 0.04441918432712555, 0.0016292538493871689, 0.06097140535712242, -0.04436047002673149, 0.05629538744688034, -0.0015229798154905438, -0.015624725259840488, 0.001711769262328744, -0.05486658960580826, -0.03255367651581764, 0.014346955344080925, 0.024190250784158707, -0.007112876512110233, -0.04582525044679642, -0.056194230914115906, 0.022743593901395798, -0.04702453687787056, 0.02359440177679062, -0.014804071746766567, 0.01694779098033905, 0.025513116270303726, -0.05615832284092903, 0.017189225181937218, 0.053450603038072586, 0.01109393686056137, -0.032923948019742966, -0.02114962972700596, 0.020565154030919075, -0.013282081112265587, 0.051348134875297546, 0.03597855940461159, -0.052788641303777695, 0.00652728509157896, -0.09305273741483688, 0.029569145292043686, -0.017962517216801643, -0.08175195008516312, 0.006872100755572319, -0.022645222023129463, 0.022976135835051537, 0.01165001280605793, -0.04838738217949867, 0.01267828419804573, 0.04086785390973091, -0.08622051775455475, 0.05876988172531128, 0.0008905719732865691, 0.013164396397769451, 0.016707412898540497, -0.08450888097286224, 0.02371891215443611, 0.052572764456272125, 0.010027775540947914, -0.004252557642757893, 0.12743347883224487, -0.014476520009338856, 0.01967010647058487, -0.037382710725069046, -0.01514469925314188, 0.017890477553009987, -0.011688053607940674, 0.053879763931035995, 0.0036685180384665728, -0.0466129444539547, -0.011788289062678814, 0.01192883774638176, 0.0024613928981125355, -0.023161334916949272, 0.025888124480843544, -0.015820756554603577, 0.021948611363768578, -0.03309130296111107, -0.0003651759761851281, -0.025605525821447372, -0.01927759125828743, -0.09478235244750977, -0.0027725237887352705, -0.05433637648820877, -0.02564915269613266, -0.07345228642225266, 0.05442851781845093, -0.03179368004202843, -0.0840371772646904, -0.010411255061626434, -0.0036859989631921053, -0.053218286484479904, 0.03537038713693619, 0.02580288052558899, 0.008077585138380527, 0.012891755439341068, 0.024545377120375633, 0.015174511820077896, 0.04603457823395729, 0.034887202084064484, -0.016944915056228638, 0.014044297859072685, -0.019171031191945076, -0.03637364134192467, -0.004824021831154823, -0.016651779413223267, 0.07059255242347717, -0.03407377004623413, 0.006946444045752287, 0.0114818774163723, -0.03176726773381233, 0.00022485223598778248, 0.02014296129345894, 0.021563123911619186, 0.01987387426197529, 0.052135709673166275, -0.04416656494140625, -0.001719480031169951, -0.026512619107961655, -0.008776170201599598, -0.004898378625512123, -0.04125635698437691, 0.035980258136987686, -0.017417268827557564, 0.023115703836083412, -0.006846396252512932, -0.060780659317970276, -0.01289337407797575, 0.011018041521310806, -0.0034081831108778715, -0.018332185223698616, -0.011771919205784798, 0.02746058814227581, 0.02932463400065899, -0.036353759467601776, -0.052403658628463745, 0.006545600946992636, -0.002182980068027973, 0.00927901640534401, 0.08921895921230316, -0.027961386367678642, 0.005469406023621559, -0.06442512571811676, -0.012972038239240646, 0.063539057970047, 0.01890796236693859, -0.004597610328346491, 0.01919196918606758, -0.01938740722835064, -0.028361676260828972, -0.029054798185825348, 0.005561774596571922, 0.0041412957943975925, -0.05721846595406532, 0.0002777467016130686, -0.04226544871926308, -0.03239772841334343, -0.04727359861135483, 0.04111822322010994, -0.03349946066737175, 0.06779758632183075, 0.028712451457977295, 0.02711133472621441, -0.02719924785196781, 0.00865891482681036, 0.022768832743167877, -0.035101085901260376, 0.01586386375129223, 0.006798134185373783, 0.05732782185077667, -0.1588912308216095, -0.018496699631214142, -0.036769237369298935, 0.0009784256108105183, 0.03340883180499077, -0.07752325385808945, -0.028390487655997276, -0.001169849536381662, 0.01610303297638893, 0.0068622673861682415, 0.03532114252448082, -0.014170474372804165, 0.006360361352562904, -0.0182708241045475, 0.006911769043654203, -0.033713944256305695, 0.00775687862187624, 0.038133297115564346, 0.009859975427389145, -0.06368985772132874, 0.0013683721190318465, 0.01070078182965517, -0.00023935281205922365, -0.03725060075521469, -0.05007929354906082, -0.022664831951260567, 0.05104038864374161, 0.010115694254636765, -0.010209393687546253, 0.009668096899986267, -0.006798389367759228, -0.029005303978919983, 0.0024985449854284525, 0.017338674515485764, 0.014478745870292187, 0.006947333458811045, 0.013094117864966393, -0.015006638132035732, 0.05475030839443207, -0.0109371617436409, -0.03251804783940315, 0.2154597043991089, -0.022766659036278725, 0.0006841731956228614, 0.010553424246609211, -0.06130770221352577, 0.04293208196759224, 0.014855794608592987, 0.03459798917174339, 0.017089104279875755, -0.029031123965978622, 0.10121636092662811, 0.01491653174161911, 0.05251796916127205, -0.028212517499923706, -0.031097283586859703, -0.004047180060297251, 0.033514898270368576, -0.05999986454844475, 0.010071859695017338, -0.039478741586208344, 0.02284497208893299, -0.0028447883669286966, 0.020284418016672134, 0.05201296880841255, -0.07988110184669495, -0.08734090626239777, -0.02690272033214569, -0.020639250054955482, 0.027782699093222618, -0.0313740149140358],
                created_at timestamp default current_timestamp,
                deleted_at timestamp,

                UNIQUE (user_id, questionary_template_id, deleted_at)
            );

            CREATE INDEX questionary_embedding_hnsw_idx ON user_questionary USING ivfflat(embedding);
            CREATE INDEX questionary_user_idx ON user_questionary(user_id);
            CREATE INDEX questionary_template_idx ON user_questionary(questionary_template_id);
        </sql>

        <sql>
            CREATE TABLE user_questionary_answer(
                id bigserial PRIMARY KEY,
                question_id bigint NOT NULL REFERENCES question(id),
                user_questionary_id bigint NOT NULL REFERENCES user_questionary(id),
                value text NOT NULL,
                ts_vector_value tsvector,
                created_at timestamp default current_timestamp,

                UNIQUE (user_questionary_id, question_id)
            );

            CREATE INDEX questionary_answer_ts_vector_value_idx ON user_questionary_answer USING GIN(ts_vector_value);
            CREATE INDEX questionary_answer_question_idx ON user_questionary_answer(question_id);
            CREATE INDEX questionary_answer_questionary_id_idx ON user_questionary_answer(user_questionary_id);
            CREATE INDEX questionary_answer_value_idx ON user_questionary_answer(value);
        </sql>
    </changeSet>
</databaseChangeLog>